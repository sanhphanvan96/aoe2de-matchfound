name: patch
on:
    workflow_dispatch:


jobs:
  patch:
    runs-on: windows-latest
    steps:
      - name: Add msbuild to PATH
        uses: microsoft/setup-msbuild@v1.1
        with:
          msbuild-architecture: x86

      - name: Checkout xexe build tools
        uses: actions/checkout@v3
        with:
          repository: securepo/xexe
          path: xexe

      - name: Retrieve executale file from artifact
        uses: actions/download-artifact@v3
        with:
          name: aoe2de-matchfound
          path: .

      - name: Compress the executable file to .bin
        run: |
          ls
          xexe/tools/tobin.exe aoe2de-matchfound.exe app.bin
          ls
          ls xexe/tools/
          Move-Item -Path app.bin -Destination xexe/src/res/app.bin -Force
          ls xexe/src/res/

      - name: Install windows-sdk-8.1
        run: choco install windows-sdk-8.1

      - name: Build app for release
        run: msbuild xexe/xexe.sln -t:rebuild -property:Configuration=Release

      - name: Check file exists
        run: ls bin

      # - name: Retrieve executale file from artifact
      #   uses: actions/download-artifact@v3
      #   with:
      #     name: aoe2de-matchfound
      #     path: .

      # - name: Check file exists
      #   run: ls -lah

      # - name: VirusTotal Scan
      #   uses: crazy-max/ghaction-virustotal@v3
      #   with:
      #     vt_api_key: ${{ secrets.VT_API_KEY }}
      #     files: |
      #       aoe2de-matchfound.exe
